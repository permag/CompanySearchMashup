var app=angular.module("app",["ngRoute"]);app.config(function($routeProvider){"use strict";$routeProvider.when("/",{templateUrl:"./views/partials/_results.html",controller:"AppCtrl"}).when("/:industry/:location/:page",{templateUrl:"./views/partials/_results.html",controller:"AppCtrl"}).otherwise({redirectTo:"/"})}),app.controller("AppCtrl",function($scope,$http,$q,$location,$routeParams,orderByFilter,eniroFactory,testPersonsFactory){"use strict";function getEniroData(industry,location,page,grab){eniroFactory.getResults(industry,location,page,grab).success(function(data){eniroData=data.adverts,$scope.totalHits=data.totalHits,createMashup(eniroData)}).error(function(){console.log("Error: Eniro API.")})}function createMashup(eniroData){var promises=[],persons=[];$.each(eniroData,function(key,value){var company=value.companyInfo.companyName,city=value.address.postArea;promises.push(testPersonsFactory.getResults(company,city))}),$q.all(promises).then(function(responsArray){$.each(eniroData,function(key,value){persons=[],$.each(responsArray,function(k,v){v.data.length>0&&value.companyInfo.companyName.toLowerCase()===v.data[0].company.toLowerCase()&&value.address.postArea.toLowerCase()===v.data[0].city.toLowerCase()&&($.each(v.data,function(kk){persons.push(v.data[kk])}),$scope.countContacts++)}),null!==value.address.postArea&&null!==value.phoneNumbers.phoneNumber&&resultList.push({industry:industry.toUpperCase(),company:value.companyInfo.companyName,city:value.address.postArea,phoneNumbers:value.phoneNumbers,persons:persons})}),$scope.mashup=resultList,$scope.loading=!1})}function checkIfSelected(){return $(".check-box").is(":checked")}function getSelected(){var checkedList=[],checkBoxes=$(".check-box");return $.each(checkBoxes,function(key,box){$(box).is(":checked")&&checkedList.push(key)}),checkedList}$scope.mashup=[],$scope.loading=!1,$scope.showAll=!0,$scope.countContacts=0,$scope.selectAllText="",$scope.addedContactsCount=0,$scope.predicate="city",$scope.totalHits=0;var addedContactsArr=[],eniroData=[],resultList=[],industry="",location="",grab=25,page=1;$routeParams.industry&&$routeParams.location&&$routeParams.page,$scope.numberOfPages=function(){return Math.floor($scope.totalHits/grab)},$scope.submitSearch=function(){$scope.loading=!0,$scope.mashup=[],$scope.countContacts=0,resultList=[],page=1,$("#check-all").find("input").removeAttr("checked"),$scope.selectAllText="Markera alla.",industry=$("#industry option:selected").attr("value"),location=$("#location option:selected").attr("value");$("#sale option:selected").attr("value");getEniroData(industry,location,page,grab)},$scope.getNext=function(){page+=1,getEniroData(industry,location,page,grab)},$scope.toggleShowAll=function(){$scope.showAll=!$scope.showAll},$scope.selectAll=function(){var checkBoxes=$(".check-box");$("#check-all").find("input").attr("checked")?(checkBoxes.attr("checked","checked"),$scope.selectAllText="Avmarkera alla."):(checkBoxes.removeAttr("checked"),$scope.selectAllText="Markera alla.")},$scope.addContacts=function(){if(checkIfSelected()&&0!==$scope.countContacts){var checkedList=getSelected();$.each($scope.mashup,function(key,value){-1!==$.inArray(key,checkedList)&&value.persons.length>0&&$.each(value.persons,function(k){$scope.addContact(value,k)})})}},$scope.addContact=function(obj,index){var csvString=obj.industry+";"+obj.city+";"+obj.company+";"+obj.persons[index].firstName+" "+obj.persons[index].lastName+";"+obj.persons[index].profileImage+";"+obj.persons[index].title+";"+obj.persons[index].email+"%0D%0A";-1===$.inArray(csvString,addedContactsArr)&&($scope.addedContactsCount++,addedContactsArr.push(csvString))},$scope.generateCSV=function(){if(0!==$scope.addedContactsCount){var csvHeader="Bransch;Stad;FÃ¶retag;Namn;Profilbild;Titel;Kontaktuppgifter%0D%0A",csvContacts=csvHeader+addedContactsArr.join("");window.open("./php/generate_csv.php?csvString="+csvContacts,"Kontakter",""),$scope.addedContactsCount=0,addedContactsArr=[]}}}),app.factory("eniroFactory",function($http){var factory={};return factory.getResults=function(industry,location,page,grab){var basicUrl="http://api.eniro.com/cs/search/basic?key=1562073226586824804&profile=permag&country=se&version=1.1.3",from=0;page=parseInt(page),from=1===page?1:page*grab;var to=from+grab-1,params="&search_word="+industry+"&geo_area="+location+"&from_list="+from+"&to_list="+to;return $http({url:basicUrl+params,method:"GET"})},factory}),app.factory("testPersonsFactory",function($http){var factory={};return factory.getResults=function(company,city){return $http({url:"./php/persons.php?company="+company+"&city="+city,method:"GET"})},factory}),app.filter("makeRange",function(){return function(input){var lowBound,highBound;switch(input.length){case 1:lowBound=0,highBound=parseInt(input[0])-1;break;case 2:lowBound=parseInt(input[0]),highBound=parseInt(input[1]);break;default:return input}for(var result=[],i=lowBound;highBound>=i;i++)result.push(i);return result}});